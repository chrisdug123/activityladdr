{% extends 'base.html' %}
{% block title %}Schedule & Events{% endblock %}
{% block content %}
<h2 class="mt-5">Event Schedule</h2>

<div class="mb-3">
    <form method="get" action="{{ url_for('main.schedule') }}">
        <label for="major_city">Select a city:</label>
        <select name="major_city" id="major_city" onchange="this.form.submit()">
            <option value="">-- Choose a city --</option>
            {% for city in cities %}
                <option value="{{ city }}" {% if city == selected_city %}selected{% endif %}>{{ city }}</option>
            {% endfor %}
        </select>
    </form>
</div>

<div id="calendar">
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Time</th> <!-- The first column header -->
                {% for date in calendar.keys() %}
                    <th>{{ date.strftime('%A, %d %B %Y') }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for hour in range(0, 24, 3) %} <!-- Loop through each timeslot -->
            <tr>
                <td>{{ '%02d:00' | format(hour) }} - {{ '%02d:00' | format((hour + 3) % 24) }}</td> <!-- Timeslot in HH:MM format -->
                {% for date, times in calendar.items() %}
                    <td>
                        {% if hour in times %}
                            {% set slot = times[hour] %}
                            {% if slot.status == 'available' %}
                                <button
                                    class="btn btn-success btn-sm"
                                    data-date="{{ date }}"
                                    data-hour="{{ hour }}"
                                    data-cost="{{ slot.cost }}"
                                    data-bs-toggle="modal"
                                    data-bs-target="#bookingModal">
                                    Book ({{ slot.cost }} bucks)
                                </button>
                            {% elif slot.status == 'booked' %}
                                <span class="badge bg-primary">Booked</span><br>
                                <small>{{ slot.suburb }}</small>
                            {% else %}
                                <span class="badge bg-secondary">Unavailable</span>
                            {% endif %}
                        {% else %}
                            <span class="badge bg-secondary">Unavailable</span>
                        {% endif %}
                    </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
</div>

<!-- Booking Modal -->
<!-- Booking Modal -->
<div id="bookingModal" class="modal fade" tabindex="-1" aria-labelledby="bookingModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bookingModalLabel">Book Slot</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="bookingForm">
                    <input type="hidden" id="modalDate" name="date">
                    <input type="hidden" id="modalHour" name="hour">

                    <div class="mb-3">
                        <label for="modalMajorCity" class="form-label">Major City</label>
                        <select class="form-select" id="modalMajorCity" name="major_city" required>
                            <option value="{}" selected disabled>Select a major city</option>
                            {% for city in cities %}
                            <option value="{{ city }}">{{ city }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="modalSuburb" class="form-label">Suburb</label>
                        <select class="form-select" id="modalSuburb" name="suburb" required>
                            <option value="" selected disabled>Select a suburb</option>
                        </select>
                    </div>
                    <p>Cost: <span id="bookingCost">0</span> bucks</p>

                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="confirmBooking">Confirm Booking</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const modal = new bootstrap.Modal(document.getElementById('bookingModal'));
        const bookingForm = document.getElementById('bookingForm');
        const majorCityDropdown = document.getElementById('modalMajorCity');
        const suburbDropdown = document.getElementById('modalSuburb');

        document.querySelectorAll('.book-slot').forEach(button => {
            button.addEventListener('click', function () {
                document.getElementById('modalDate').value = this.getAttribute('data-date');
                document.getElementById('modalHour').value = this.getAttribute('data-hour');
                modal.show();
            });
        });

        majorCityDropdown.addEventListener('change', function () {
            const selectedCity = this.value;

            // Clear existing suburbs
            suburbDropdown.innerHTML = '<option value="" selected disabled>Select a suburb</option>';

            // Fetch suburbs for the selected city
            fetch(`/suburbs/${selectedCity}`)
                .then(response => response.json())
                .then(data => {
                    data.forEach(suburb => {
                        const option = document.createElement('option');
                        option.value = suburb;
                        option.textContent = suburb;
                        suburbDropdown.appendChild(option);
                    });
                })
                .catch(error => console.error('Error fetching suburbs:', error));
        });

        document.getElementById('confirmBooking').addEventListener('click', function () {
            const formData = new FormData(bookingForm);
            const bookingData = {
                date: formData.get('date'),
                hour: formData.get('hour'),
                major_city: formData.get('major_city'),
                suburb: formData.get('suburb')
            };

            fetch(`/book-slot`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(bookingData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Slot booked successfully!');
                    location.reload(); // Reload to update the calendar
                } else {
                    alert('Error booking slot: ' + data.message);
                }
            })
            .catch(error => console.error('Error booking slot:', error));
        });
    });

    document.querySelectorAll('button[data-bs-target="#bookingModal"]').forEach((button) => {
    button.addEventListener('click', (e) => {
        const date = button.dataset.date;
        const hour = button.dataset.hour;
        const cost = button.dataset.cost;

        document.querySelector('#bookingForm input[name="date"]').value = date;
        document.querySelector('#bookingForm input[name="hour"]').value = hour;
        document.querySelector('#bookingCost').textContent = cost;
    });
});

</script>
{% endblock %}
