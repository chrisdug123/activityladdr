{% extends 'base.html' %}
{% block title %}Schedule & Events{% endblock %}

{% block content %}
<h2 class="mt-5">Event Schedule</h2>

<!-- City Selector -->
<div class="mb-3">
    <form method="get" action="{{ url_for('main.schedule') }}">
        <label for="major_city" class="form-label">Select a city:</label>
        <select name="major_city" id="major_city" class="form-select" onchange="this.form.submit()">
            <option value="">-- Choose a city --</option>
            {% for city in cities %}
                <option value="{{ city }}" {% if city == selected_city %}selected{% endif %}>{{ city }}</option>
            {% endfor %}
        </select>
    </form>
</div>

<!-- Legend -->
<div class="mb-3">
    <strong>Legend:</strong>
    <div class="d-flex align-items-center flex-wrap">
        <div class="btn btn-success btn-sm me-2" style="pointer-events: none;">0 bucks</div>
        <div class="btn btn-primary btn-sm me-2" style="pointer-events: none;">1 buck</div>
        <div class="btn btn-info btn-sm me-2" style="pointer-events: none;">2 bucks</div>
        <div class="btn btn-warning btn-sm me-2" style="pointer-events: none;">3 bucks</div>
        <div class="btn btn-purple btn-sm me-2" style="pointer-events: none;">4 bucks</div>
        <div class="btn btn-danger btn-sm" style="pointer-events: none;">5 bucks</div>
    </div>
</div>

<!-- Schedule Table -->
<div id="schedule" class="table-responsive">
    <table class="table table-bordered table-hover">
   <thead class="table-light text-center">
    <tr>
        <th style="width: 10%;">Time</th> <!-- Allocate a smaller width for the Time column -->
        {% for date in calendar.keys() %}
            <th style="width: {{ 90 / calendar|length }}%;">
                {{ date.strftime('%a %d') }} <!-- Compact format -->
            </th>
        {% endfor %}
    </tr>
</thead>

        
        <tbody>
            {% for hour in range(0, 24, 3) %}
            <tr>
                <!-- Timeslot -->
                <td class="text-center {% if hour == current_hour and today_date in calendar.keys() %}table-warning fw-bold{% endif %}">
                    {{ hour % 12 or 12 }}{{ 'a' if hour < 12 else 'p' }}â€“{{ (hour + 3) % 12 or 12 }}{{ 'a' if (hour + 3) < 12 else 'p' }}
                </td>
                

                <!-- Availability for Each Day -->
                {% for date, times in calendar.items() %}
                <td>
                    {% if hour in times %}
                        {% set slot = times[hour] %}
                        {% if slot.status == 'available' %}
                            <!-- Assign button color based on specific cost -->
                            <button
                            class="btn {% if slot.cost == 0 %}btn-success
                                        {% elif slot.cost == 1 %}btn-primary
                                        {% elif slot.cost == 2 %}btn-info
                                        {% elif slot.cost == 3 %}btn-warning
                                        {% elif slot.cost == 4 %}btn-purple
                                        {% elif slot.cost == 5 %}btn-danger{% endif %} btn-sm book-slot"
                            data-date="{{ date }}"
                            data-hour="{{ hour }}"
                            data-cost="{{ slot.cost }}"
                            data-bs-toggle="modal"
                            data-bs-target="#bookingModal">
                            Book
                        </button>
                        
                        {% elif slot.status == 'booked' %}
                            <span class="badge bg-primary">Booked</span><br>
                            <small>{{ slot.suburb }}</small>
                        {% else %}
                            <span class="badge bg-secondary">Booked</span>
                        {% endif %}
                    {% else %}
                        <span class="badge bg-secondary">Booked</span>
                    {% endif %}
                </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Booking Modal -->
<div id="bookingModal" class="modal fade" tabindex="-1" aria-labelledby="bookingModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bookingModalLabel">Confirm Booking</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="bookingForm">
                    <p>Booking slot:</p>
                    <p>Date: <span id="modalDate"></span></p>
                    <p>Time: <span id="modalTime"></span></p>
                    <p>Cost: <span id="bookingCost"></span> bucks</p>
                    <input type="hidden" id="modalDateInput" name="date">
                    <input type="hidden" id="modalHourInput" name="hour">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="confirmBooking">Confirm Booking</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Handle slot booking
        document.querySelectorAll('.book-slot').forEach(button => {
            button.addEventListener('click', function () {
                const date = this.getAttribute('data-date');
                const hour = this.getAttribute('data-hour');
                const cost = this.getAttribute('data-cost');

                // Update modal with selected slot info
                document.getElementById('modalDate').textContent = date;
                document.getElementById('modalTime').textContent = `${hour}:00 - ${(parseInt(hour) + 3) % 24}:00`;
                document.getElementById('bookingCost').textContent = cost;

                // Update hidden inputs
                document.getElementById('modalDateInput').value = date;
                document.getElementById('modalHourInput').value = hour;
            });
        });

        // Confirm booking
        document.getElementById('confirmBooking').addEventListener('click', function () {
            const formData = new FormData(document.getElementById('bookingForm'));
            const bookingData = {
                date: formData.get('date'),
                hour: formData.get('hour'),
            };

            fetch(`/book-slot`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(bookingData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Slot booked successfully!');
                    location.reload(); // Reload to update the schedule
                } else {
                    alert('Error booking slot: ' + data.message);
                }
            })
            .catch(error => console.error('Error booking slot:', error));
        });
    });
</script>
{% endblock %}
